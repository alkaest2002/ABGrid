{%- macro highlight_value(value, highlight_values, is_min, is_max) %}
    {%- set highlight = namespace(value=False) %}
    {%- for (min, max, label) in highlight_values %}
        {%- if value >= min and value <= max %}
            {%- set highlight.value = True %}
            {{ label }}
        {%- endif %}
    {%- endfor %}
    {%- if not highlight.value %}
        {%- if is_min[0] %}{{ is_min[1] }}{% endif %}
        {%- if is_max[0] %}{{ is_max[1] }}{% endif %}
    {%- endif %}
{%- endmacro %}

{% macro render_question(network_type, question) %}
<div class="question-container">
    <div class="question-main">
        <p><b>{{ network_type }}. {{ question }}</b></p> 
    </div>
</div>
{% endmacro %}

{% macro render_graph(graph) %}
<div class="graph-container">
    <div classÃ¬="graph-main">
        <img src="{{ graph }}" />
    </div>
</div>
{% endmacro %}

{% macro render_sociogram_graphs(graph, graph_label) %}
<div class="sociogram-graphs-container">
    <div class="sociogram-graphs-main">
        <div class="sociogram-graphs-header">
            <b>{{ graph_label }}</b>
        </div>
        {{ render_graph(graph) }}
    </div>
</div>
{% endmacro %}

{% macro render_sna_macro_statistics(data) %}
<div class="sna-macro-stats-container">
    <div class="sna-macro-stats-main">
        <p>
            <b>NN</b> {{ data.network_nodes }}, <b>NE</b> {{ data.network_edges }}, <b>ND</b> {{ (data.network_density * 100)|round|int }}%, <b>NC</b> {{ (data.network_centralization * 100)|round|int }}%, <b>NT</b> {{ (data.network_transitivity * 100)|round|int }}%, <b>NR</b> {{ (data.network_reciprocity * 100)|round|int }}%
        </p>
    </div>
</div>
{% endmacro %}

{% macro render_sna_micro_statistics(network_type, score_type, data, render_choices_label) %}
{% set last_rank_ic = data.values()|map(attribute='ic_rank') | max  %}
{% set last_rank_pr = data.values()|map(attribute='pr_rank') | max  %}
{% set last_rank_bt = data.values()|map(attribute='bt_rank') | max  %}
{% set last_rank_cl = data.values()|map(attribute='cl_rank') | max  %}
{% set last_rank_hu = data.values()|map(attribute='hu_rank') | max  %}
{% set highlight_values = [
    (0, 5/100, "highlight-very-low-values"),
    (5/100, 10/100, "highlight-low-values"),
    (85/100, 95/100, "highlight-high-values"),
    (95/100, 1, "highlight-very-high-values"),
] %}
<div class="sna-micro-stats-container">
    <table class="table-data table-bordered table-striped full-width">
        <tr>
            <th>ID</th>
            <th>{{ render_choices_label() }}</th>
            <th>IC</th>
            <th>PR</th>
            <th>BT</th>
            <th>CL</th>
            <th>HU</th>
            <th>ND</th>
        </tr>
        {% for k in data.keys() %}
            {% if score_type == "ranks" %}
                <tr>
                    <td>{{ k }}</td>
                    <td>{{ data[k].lns | default("-", boolean=True) }}</td>
                    <td>
                        <div>
                            {% set value = data[k].ic_pctile %}
                            {% set rank = data[k].ic_rank %}
                            {% set is_first = (rank == 1, "highlight-high-values") %}
                            {% set is_last = (rank == last_rank_ic, "highlight-low-values") %}
                            <div class="{{ highlight_value(value, highlight_values, is_first, is_last) }}">
                                {{ data[k].ic_rank | int }}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>
                            {% set value = data[k].pr_pctile %}
                            {% set rank = data[k].pr_rank %}
                            {% set is_first = (rank == 1, "highlight-high-values") %}
                            {% set is_last = (rank == last_rank_pr, "highlight-low-values") %}
                            <div class="{{ highlight_value(value, highlight_values, is_first, is_last) }}">
                                {{ data[k].pr_rank | int }}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>
                            {% set value = data[k].bt_pctile %}
                            {% set rank = data[k].bt_rank %}
                            {% set is_first = (rank == 1, "highlight-high-values") %}
                            {% set is_last = (rank == last_rank_bt, "highlight-low-values") %}
                            <div class="{{ highlight_value(value, highlight_values, is_first, is_last) }}">
                                {{ data[k].bt_rank | int }}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>
                            {% set value = data[k].cl_pctile %}
                            {% set rank = data[k].cl_rank %}
                            {% set is_first = (rank == 1, "highlight-high-values") %}
                            {% set is_last = (rank == last_rank_cl, "highlight-low-values") %}
                            <div class="{{ highlight_value(value, highlight_values, is_first, is_last) }}">
                                {{ data[k].cl_rank | int }}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>
                            {% set value = data[k].hu_pctile %}
                            {% set rank = data[k].hu_rank %}
                            {% set is_first = (rank == 1, "highlight-high-values") %}
                            {% set is_last = (rank == last_rank_hu, "highlight-low-values") %}
                            <div class="{{ highlight_value(value, highlight_values, is_first, is_last) }}">
                                {{ data[k].hu_rank | int }}
                            </div>
                        </div>
                    </td>
                    <td >{% if data[k].nd == 1 %}&larr;{% elif data[k].nd == 2 %}&rarr;{% elif data[k].nd == 3 %}&rlarr;{% endif %}</td>
                </tr>
            {% else %}
                <tr>
                    <td>{{ k }}</td>
                    <td>{{ data[k].lns | default("-", boolean=True) }}</td>
                    <td>{{ "%0.2f"| format(data[k].ic_raw | round(2)) }}</td>
                    <td>{{ "%0.2f"| format(data[k].pr_raw | round(2)) }}</td>
                    <td>{{ "%0.2f"| format(data[k].bt_raw | round(2)) }}</td>
                    <td>{{ "%0.2f"| format(data[k].cl_raw | round(2)) }}</td>
                    <td>{{ "%0.2f"| format(data[k].hu_raw | round(2)) }}</td>
                    <td>{% if data[k].nd == 1 %}&larr;{% elif data[k].nd == 2 %}&rarr;{% elif data[k].nd == 3 %}&rlarr;{% endif %}</td>
                </tr>
            {% endif %}
        {% endfor %}
    </table>
</div>
{% endmacro %}

{% macro render_rankings(rankings, render_rank_label) %}
<div class="rankings-container">
    {% for metric, data in rankings.items() %}
        <div class="rankings-main">
            <table class="table-data table-bordered table-striped full-width table-rankings">
                <tr>
                    <th>{{ render_rank_label() }}</th>
                    <th>{{ metric[:2] | upper }}</th>
                </tr>
                {% for letter, rank in data.items() %}
                    <tr>
                        <td>
                            <div><div>{{ rank }}</div></div>
                        </td>
                        <td>
                            <div><div>{{ letter }}</div></div>
                        </td>
                    </tr>
                {% endfor %}
            </table>
        </div>
    {% endfor %}
</div>
{% endmacro %}

{% macro render_edges_type(network_type, edges_types, render_edges_types_label, render_edges_type_empty_list) %}
<div class="sna-edges-types-container">
    {% for edges_type, edges in edges_types.items() %}
        <div class="sna-edges-type-main">
            {% set edges_length = edges | length %}
            <div class="mb-md sna-edges-type-header mt-lg">
                {{ render_edges_types_label(network_type, edges_type, edges_length) }}
            </div>
            <div class="sna-edges-type-list">
                {% if  edges | length > 0 %}
                    {% for edge in edges %}
                        <div class="sna-edge">     
                            {% for node in edge %}
                                <span>{{ node }}</span>{% if loop.index0 == 0 %} &middot; {% endif %}
                            {% endfor %}
                        </div>
                    {% endfor %}
                {% else %}
                    {{ render_edges_type_empty_list()  }}
                {% endif %}
            </div>
        </div>
    {% endfor %}
</div>
{% endmacro %}

{% macro render_sna_components(all_components, render_components_label, render_components_empty_list) %}
<div class="sna-components-container">
    {% for type, components in all_components.items() %}
        <div class="sna-components-main">
            {% set current = namespace(length=None) %}
            <div class="sna-components-type-header mt-lg" >
                {{ render_components_label(type) }}
            </div>
            <div class="sna-components-list mt-md mb-lg">
                {% if  components | length > 0 %}
                    {% for component in components %}
                        <div class="sna-component">
                            {% if not current.length or current.length != (component | length) %}
                                {% set current.length = component | length %}
                                <span class="sna-component-length">{{ current.length }}</span>
                                {% for node in component %}
                                    <span>{{ node }}</span>{% if not loop.last %} &middot;{% endif %}
                                {% endfor %}
                            {% else %}
                                {% for node in component %}
                                    <span {% if loop.first %}style="margin-left:5pt"{% endif %}>
                                        {{ node }}</span>{% if not loop.last %} &middot;{% endif %}
                                {% endfor %}
                            {% endif %}           
                        </div>
                    {% endfor %}
                {% else %}
                    {{ render_components_empty_list() }}
                {% endif %}
            </div>
        </div>
    {% endfor %}
</div>
{% endmacro %}

{% macro render_sociogram_micro_statistics(data, render_sociogram_status_label) %}
{% set coeff_highlight_values = [
    (0, 70, "highlight-very-low-values"),
    (70, 85, "highlight-low-values"),
    (115, 130, "highlight-high-values"),
    (130, 500, "highlight-very-high-values"),
] %}
<div class="sociogram-micro-stats-container">
    <div class="sociogram-micro-stats-main">
        <table class="table-data table-bordered table-striped full-width">
            <tr>
                <th>ID</th>
                <th>RP</th>
                <th>RR</th>
                <th>GP</th>
                <th>GR</th>
                <th>MP</th>
                <th>MR</th>
                <th>BL</th>
                <th>OR</th>
                <th>IM</th>
                <th>AC</th>
                <th>IC</th>
                <th>ST</th>
            </tr>
            {% for k in data.keys() %}
                <tr>
                    <td><div><div>{{ k }}</div></div></td>
                    <td><div><div>{{ data[k].rp }}</div></div></td>
                    <td><div><div>{{ data[k].rr }}</div></div></td>
                    <td><div><div>{{ data[k].gp }}</div></div></td>
                    <td><div><div>{{ data[k].gr }}</div></div></td>
                    <td><div><div>{{ data[k].mp }}</div></div></td>
                    <td><div><div>{{ data[k].mr }}</div></div></td>
                    <td><div><div>{{ data[k].bl }}</div></div></td>
                    <td><div><div>{{ data[k].or }}</div></div></td>
                    <td><div><div>{{ data[k].im }}</div></div></td>
                    <td>
                        <div>
                            {% set value = data[k].ac %}
                            <div class="{{ highlight_value(value, coeff_highlight_values, (False, ''), (False, '')) }}">
                                {{ data[k].ac_raw }}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>
                            {% set value = data[k].ic %}
                            <div class="{{ highlight_value(value, coeff_highlight_values, (False, ''), (False, '')) }}">
                                {{ data[k].ic_raw }}
                            </div>
                        </div>
                    </td>
                    <td><div><div>{{ render_sociogram_status_label(data[k].st) }}</div></div></td>
                </tr>
            {% endfor %}
        </table>
    </div>
</div>
{% endmacro %}

{% macro render_sociogram_macro_statistics(macro_stats, supplemental, render_sociogram_measures_label) %}
<div class="sociogram-supplemental-container">
    <div class="sociogram-supplemental-container-main">
        <p class="mt-md">
            <span class="text-italic">
                {{- render_sociogram_measures_label("ui_i") -}}: 
                    {{ "%0.2f"| format(supplemental["ui_i"] * 100 | round(0)) }}%
            </span>,
            <span class="text-italic">,
                {{- render_sociogram_measures_label("ui_ii") -}}: 
                    {{ "%0.2f"| format(supplemental["ui_ii"] | round(2)) }}
            </span>
        </p>
        <p class="mb-md">
            <span class="text-italic">
                {{- render_sociogram_measures_label("wi_i") -}}: 
                    {{ "%0.2f"| format(supplemental["wi_i"] * 100 | round(0)) }}%
            </span>
            <span class="text-italic">,
                {{- render_sociogram_measures_label("wi_ii") -}}: 
                    {{ "%0.2f"| format(supplemental["wi_ii"] | round(2)) }}
            </span>
        </p>
        <table class="table-data table-bordered table-striped full-width">
            <tr>
                <th class="text-left">ID</th>
                <th>Count</th>
                <th>Median</th>
                <th>IQR</th>
                <th>Mean</th>
                <th>SD</th>
                <th>Min</th>
                <th>P25</th>
                <th>P50</th>
                <th>P75</th>
                <th>Max</th>
            </tr>
            {% for k in macro_stats.keys() %}
                {% if k not in ["ac", "ic"] %}
                    <tr>
                        <td class="text-left"><div><div>{{ render_sociogram_measures_label(k) }}</div></div></td>
                        <td><div><div>{{ macro_stats[k].count }}</div></div></td>
                        <td><div><div>{{ macro_stats[k].median | int }}</div></div></td>
                        <td><div><div>{{ macro_stats[k].iqr | int }}</div></div></td>
                        <td><div><div>{{ "%0.2f" | format(macro_stats[k].mean | round(2)) }}</div></div></td>
                        <td><div><div>{{ "%0.2f" | format(macro_stats[k].std | round(2)) }}</div></div></td>
                        <td><div><div>{{ macro_stats[k].min |int }}</div></div></td>
                        <td><div><div>{{ macro_stats[k]["25%"] | int }}</div></div></td>
                        <td><div><div>{{ macro_stats[k]["50%"] | int }}</div></div></td>
                        <td><div><div>{{ macro_stats[k]["75%"] | int }}</div></div></td>
                        <td><div><div>{{ macro_stats[k]["max"] | int }}</div></div></td>
                    </tr>
                {% endif %}
            {% endfor %}
        </table>
    </div>
</div>
{% endmacro %}
